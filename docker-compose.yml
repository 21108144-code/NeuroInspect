# docker-compose.yml - NeuroInspect Full Stack
version: '3.8'

services:
  # Backend API Service
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: neuroinspect-backend
    ports:
      - "8000:8000"
    environment:
      - APP_ENV=production
      - DEBUG=false
      - MODEL_DEVICE=cuda
      - DATABASE_URL=sqlite+aiosqlite:///./data/neuroinspect.db
      - CORS_ORIGINS=["http://localhost:4000","http://localhost:5173"]
    volumes:
      - ./backend/data:/app/data
      - ./backend/weights:/app/weights
      - ./backend/logs:/app/logs
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [ gpu ]
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped

  # Frontend Service
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: neuroinspect-frontend
    ports:
      - "4000:80"
    environment:
      - VITE_API_URL=http://localhost:8000
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped

  # Development mode - Backend with hot reload
  backend-dev:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: neuroinspect-backend-dev
    ports:
      - "8000:8000"
    environment:
      - APP_ENV=development
      - DEBUG=true
      - MODEL_DEVICE=cuda
    volumes:
      - ./backend:/app
      - ./backend/data:/app/data
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    profiles:
      - dev

  # Development mode - Frontend with Vite dev server
  frontend-dev:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    container_name: neuroinspect-frontend-dev
    ports:
      - "5173:5173"
    environment:
      - VITE_API_URL=http://localhost:8000
    volumes:
      - ./frontend:/app
      - /app/node_modules
    command: npm run dev -- --host
    profiles:
      - dev

networks:
  default:
    name: neuroinspect-network

volumes:
  backend-data:
  backend-weights:
